[{"type":"text","text":"## Build and sync claude-mem plugin to marketplace location\n*Source: claude-mem://observation/10758*\n\n**Built all hooks and services, synced to marketplace directory, and installed dependencies successfully.**\n\nThe claude-mem plugin was fully built and deployed to the marketplace directory. The build process compiled all React components, bundled the worker service and search server, and built each individual hook. The build script used scripts/build-hooks.js to generate production-ready bundles in the plugin/scripts/ directory. After building, rsync transferred all 11781 files to the marketplace directory at ~/.claude/plugins/marketplaces/thedotmack/, removing the .git directory and .install-version file in the process. The sync command used --delete flag to ensure the marketplace directory perfectly mirrors the development directory. Finally, npm install ran in the marketplace directory to ensure all dependencies are available for the deployed plugin.\n\n---\nType: change | Facts: Built claude-mem version 6.0.9 including React viewer, worker service, search server, and all hooks; Worker service built to 1338.75 KB, search server to 335.14 KB; Synced 11781 files from development directory to ~/.claude/plugins/marketplaces/thedotmack/; All hooks built successfully: context-hook (38.29 KB), new-hook (32.14 KB), save-hook (32.49 KB), summary-hook (34.61 KB), cleanup-hook (31.38 KB), user-message-hook (2.24 KB); Dependencies auto-installed in marketplace location after sync | Concepts: what-changed, how-it-works | Files: scripts/build-hooks.js, package.json, plugin/scripts/worker-service.cjs, plugin/scripts/search-server.mjs, plugin/scripts/context-hook.js, plugin/scripts/new-hook.js, plugin/scripts/save-hook.js, plugin/scripts/summary-hook.js, plugin/scripts/cleanup-hook.js, plugin/scripts/user-message-hook.js, plugin/ui/viewer-bundle.js, plugin/ui/viewer.html\n\n---\nDate: 11/17/2025, 11:51:51 PM\n\n---\n\n## Unified search handler implements Chroma-first with FTS5 fallback on zero results\n*Source: claude-mem://observation/10757*\n\n**Lines 403-489 show current implementation attempts Chroma first, falls back to FTS5 when empty.**\n\nThe unified search handler in search-server.ts (lines 390-489) reveals the current implementation architecture. The handler first attempts Chroma semantic search when chromaClient is available, calling queryChroma with the query parameter at line 419. If Chroma throws an error, it catches at line 465 and falls through to FTS5. However, the problematic FTS5 fallback logic at line 470 triggers when all result arrays are empty, not just on errors. This contradicts the insight that FTS5 contains identical data to Chroma, making zero-result fallback pointless. Additionally, lines 476-483 call search methods (searchObservations, searchSessions, searchUserPrompts) with the query parameter without checking if it's undefined, which will cause failures when query is not provided. The handler needs modification to skip Chroma when query is undefined and only fall back to FTS5 on Chroma errors.\n\n---\nType: discovery | Facts: Line 403 checks `if (chromaClient)` to attempt Chroma semantic search first; Line 419 calls `queryChroma(query, 100, whereFilter)` with query parameter as required; Lines 465-467 catch Chroma errors and fall through to FTS5 fallback; Line 470 triggers FTS5 fallback when all result arrays have zero length; Lines 476-483 call SessionSearch methods with query parameter without checking if undefined; Hybrid search applies 90-day recency filter at lines 424-431 | Concepts: how-it-works, problem-solution, gotcha | Files: src/servers/search-server.ts\n\n---\nDate: 11/17/2025, 11:50:29 PM\n\n---\n\n## Add filter-only query path to searchUserPrompts method\n*Source: claude-mem://observation/10755*\n\n**Method accepts undefined query and handles dual-path logic with separate parameter arrays for clarity.**\n\nThe searchUserPrompts method has been enhanced with filter-only query support, completing the pattern established in searchObservations and searchSessions. The method signature now accepts optional query parameter. The implementation builds base filter conditions once for project and date range filters, then diverges into two paths. The filter-only path (when query is undefined) validates that at least some filters exist, then queries the user_prompts table directly with a WHERE clause, joining sdk_sessions for project filtering. The FTS5 path rebuilds filter conditions into a separate ftsParams array to avoid parameter ordering conflicts between the two paths. This dual-path approach enables both semantic/keyword search via FTS5 and pure metadata filtering via direct SQLite queries, completing the architectural pattern across all three search methods.\n\n---\nType: feature | Facts: searchUserPrompts signature changed to accept `query: string | undefined` at line 541; Filter conditions built once and shared between filter-only and FTS5 paths at lines 546-563; Filter-only path at lines 566-588 validates filters exist and queries user_prompts table directly; FTS5 path at lines 591-616 rebuilds filter conditions with separate ftsParams array to avoid parameter conflicts; Filter-only path joins sdk_sessions table for project filtering support; Documentation updated to clarify dual-mode operation matching searchObservations and searchSessions patterns | Concepts: what-changed, how-it-works, pattern, gotcha | Files: src/services/sqlite/SessionSearch.ts\n\n---\nDate: 11/17/2025, 11:50:08 PM\n\n---\n\n## searchUserPrompts Uses Custom ORDER BY Logic Instead of buildOrderClause\n*Source: claude-mem://observation/10754*\n\n**Unlike searchObservations, searchUserPrompts implements inline ORDER BY construction with hard-coded table aliases rather than using buildOrderClause helper.**\n\nThe searchUserPrompts method implements its ORDER BY logic inline rather than using the buildOrderClause helper method used by searchObservations and searchSessions. Lines 619-623 show a ternary expression that constructs the ORDER BY clause with hard-coded references to user_prompts_fts.rank for relevance ordering and up.created_at_epoch for date-based sorting. The main SQL query joins three tables: user_prompts, user_prompts_fts, and sdk_sessions, with the sdk_sessions join enabling project-based filtering. When implementing the filter-only path for this method, the code will need to construct a query that joins only user_prompts and sdk_sessions (skipping user_prompts_fts), and the ORDER BY logic will need to handle the absence of FTS5 rank data, defaulting to date-based ordering when query is undefined.\n\n---\nType: discovery | Facts: searchUserPrompts constructs ORDER BY clause inline at lines 619-623 instead of calling buildOrderClause; The inline ORDER BY uses hard-coded table alias user_prompts_fts.rank for relevance ordering; Date-based ordering uses up.created_at_epoch for both ascending and descending sorts; The SQL query joins user_prompts, user_prompts_fts, and sdk_sessions tables; searchUserPrompts will need filter-only path to query user_prompts without user_prompts_fts JOIN when query is undefined | Concepts: how-it-works, pattern | Files: src/services/sqlite/SessionSearch.ts\n\n---\nDate: 11/17/2025, 11:50:07 PM\n\n---\n\n## User Prompts Search Joins Three Tables for Filtering\n*Source: claude-mem://observation/10753*\n\n**searchUserPrompts method joins user_prompts, user_prompts_fts, and sdk_sessions tables to enable project-based filtering.**\n\nThe searchUserPrompts method demonstrates a more complex query structure than searchObservations or searchSessions due to the need for project filtering. Since user_prompts don't directly store project information, the method joins with the sdk_sessions table using claude_session_id as the key, which allows filtering by the project field from sdk_sessions. The query structure follows the same FTS5 pattern seen in other search methods: it joins the base table (user_prompts) with its FTS5 virtual table (user_prompts_fts) via rowid, uses the MATCH operator for full-text search, and orders by rank for relevance-based results. The default limit is set to 20 rather than 50, suggesting user prompts are typically returned in smaller batches. Like the other search methods, rank values are normalized to a 0-1 score scale where higher values indicate better matches, inverting FTS5's native lower-is-better ranking.\n\n---\nType: discovery | Facts: searchUserPrompts method joins three tables: user_prompts, user_prompts_fts, and sdk_sessions; sdk_sessions table joined via claude_session_id to enable project filtering on user prompts; user_prompts table aliased as 'up' and uses MATCH operator on user_prompts_fts virtual table; Default limit for user prompts is 20, compared to 50 for observations and sessions; Method supports dateRange filtering using created_at_epoch column from user_prompts table; Rank normalization converts FTS5 rank scores to 0-1 scale where higher values indicate better matches | Concepts: how-it-works, pattern | Files: /Users/alexnewman/Scripts/claude-mem/src/services/sqlite/SessionSearch.ts\n\n---\nDate: 11/17/2025, 11:49:42 PM"}]